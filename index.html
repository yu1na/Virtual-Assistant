<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Virtual Desk Assistant - Hiyori</title>

  <!-- ë§ˆí¬ë‹¤ìš´ íŒŒì„œ (marked.js) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- CSS íŒŒì¼ ë§í¬ (ìˆœì„œ ì¤‘ìš”: live2dê°€ ë¨¼ì €, íŒ¨ë„ë“¤ì´ ë‚˜ì¤‘) -->
  <link rel="stylesheet" href="renderer/styles/live2d.css" />
  <link rel="stylesheet" href="renderer/styles/chat.css" />
  <!-- <link rel="stylesheet" href="renderer/styles/tasks.css" /> -->

   <!-- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë°°ê²½ ì™„ì „ íˆ¬ëª…) -->
    <style>
      html, body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        background: transparent;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        /* pointer-eventsëŠ” ê° ìš”ì†Œë³„ë¡œ CSSì—ì„œ ì œì–´ */
      }
      #user-display {
        position: absolute;
        top: 10px;
        right: 12px;
        padding: 6px 10px;
        background: rgba(0,0,0,0.55);
        color: #fff;
        border-radius: 8px;
        font-size: 12px;
        z-index: 2000;
        pointer-events: none;
      }
      /* ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ì€ ë³„ë„ CSS íŒŒì¼ë¡œ ë¶„ë¦¬ë¨ */
    </style>
</head>

<body>
  <!-- ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸: ë¨¼ì € ë¡œë“œ (ì „ì—­ìœ¼ë¡œ export) -->
  <script type="module" src="./renderer/chat/chatUI.js"></script>

  <!-- Live2D ìŠ¤í…Œì´ì§€ (ë°°ê²½, ì „ì²´ í™”ë©´) -->
  <div id="stage"></div>
  <div id="user-display">Not logged in</div>
  
  <!-- ì±„íŒ… íŒ¨ë„ (ê³ ì • ìœ„ì¹˜, ìµœìƒìœ„) -->
  <div id="chat-panel">
    <h2>ğŸ’¬ AI ë¹„ì„œ</h2>
    <div id="messages"></div>
    <div id="input-area">
      <input 
        type="text" 
        id="chat-input" 
        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
        autocomplete="off"
      />
      <button id="send-btn">ì „ì†¡</button>
    </div>
  </div>

  <script>
    /****************************************************************
     * Electron ipcRenderer ì¤€ë¹„
     * - ë¸Œë¼ìš°ì €ë¡œ ì—´ì—ˆì„ ë•ŒëŠ” requireê°€ ì—†ìœ¼ë‹ˆ try/catch
     ****************************************************************/
    let ipcRenderer = null;
    try {
      // electron í™˜ê²½
      ipcRenderer = require('electron').ipcRenderer;
    } catch (e) {
      console.warn('Electron í™˜ê²½ì´ ì•„ë‹ˆì–´ì„œ ipcRenderer ì—†ìŒ:', e);
    }

    /****************************************************************
     * Activity Monitor (ì¸ë¼ì¸)
     ****************************************************************/
    let activityMonitorCleanup = null;
    
    // Activity Monitor ì„¤ì •
    const ACTIVITY_CONFIG = {
      dev: {
        idleThresholdMs: 3 * 1000,        // 3ì´ˆ (í…ŒìŠ¤íŠ¸ìš©)
        longActiveThresholdMs: 10 * 1000, // 10ì´ˆ (í…ŒìŠ¤íŠ¸ìš©)
        checkIntervalMs: 1000,
      },
      prod: {
        idleThresholdMs: 10 * 60 * 1000,      // 10ë¶„
        longActiveThresholdMs: 50 * 60 * 1000, // 50ë¶„ (5ë¶„ ì´í•˜ íœ´ì‹ í—ˆìš©)
        checkIntervalMs: 5000,                   // 5ì´ˆë§ˆë‹¤ ì²´í¬
      }
    };
    
    function setupActivityMonitor(options) {
      const { mode, onIdle, onLongActive } = options;
      const config = ACTIVITY_CONFIG[mode];
      
      // Activity Monitor ì‹œì‘ (ë¡œê·¸ ì œê±°)
      
      let lastInputAt = Date.now();
      let sessionStartAt = Date.now();
      let isIdle = false;
      let hasNotifiedLongActive = false;
      let checkTimer = null;
      
      function handleUserInput() {
        const now = Date.now();
        lastInputAt = now;
        
        if (isIdle) {
          // í™œë™ ì¬ê°œ
          isIdle = false;
          sessionStartAt = now;
          hasNotifiedLongActive = false;
        }
      }
      
      function checkActivity() {
        const now = Date.now();
        const timeSinceLastInput = now - lastInputAt;
        const currentSessionDuration = now - sessionStartAt;
        
        // Idle ì²´í¬
        if (!isIdle && timeSinceLastInput >= config.idleThresholdMs) {
          isIdle = true;
          // Idle ìƒíƒœ ì§„ì…
          
          try {
            onIdle();
          } catch (error) {
            console.error('âŒ onIdle ì½œë°± ì˜¤ë¥˜:', error);
          }
          
          sessionStartAt = now;
          hasNotifiedLongActive = false;
          return;
        }
        
        // ì¥ì‹œê°„ í™œë™ ì²´í¬
        if (!isIdle && !hasNotifiedLongActive) {
          if (currentSessionDuration >= config.longActiveThresholdMs) {
            hasNotifiedLongActive = true;
            // ì¥ì‹œê°„ í™œë™ ê°ì§€
            
            try {
              onLongActive();
            } catch (error) {
              console.error('âŒ onLongActive ì½œë°± ì˜¤ë¥˜:', error);
            }
          }
        }
        
        // ë””ë²„ê¹… ë¡œê·¸
        if (mode === 'dev' && !isIdle && !hasNotifiedLongActive) {
          const remaining = (config.longActiveThresholdMs - currentSessionDuration) / 1000;
          if (remaining > 0 && Math.floor(remaining) % 2 === 0) {
            // ì¥ì‹œê°„ í™œë™ ì¹´ìš´íŠ¸ë‹¤ìš´ (ë¡œê·¸ ì œê±°)
          }
        }
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const events = ['mousemove', 'mousedown', 'wheel', 'keydown'];
      events.forEach(eventType => {
        window.addEventListener(eventType, handleUserInput, { passive: true });
      });
      
      // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      
      // íƒ€ì´ë¨¸ ì‹œì‘
      checkTimer = setInterval(checkActivity, config.checkIntervalMs);
      // ì£¼ê¸°ì  ì²´í¬ ì‹œì‘
      
      // Cleanup í•¨ìˆ˜ ë°˜í™˜
      return function cleanup() {
        // Activity Monitor ì •ë¦¬
        events.forEach(eventType => {
          window.removeEventListener(eventType, handleUserInput);
        });
        if (checkTimer) {
          clearInterval(checkTimer);
        }
      };
    }
    
    function setupActivityMonitorWithMotions() {
      const mode = 'prod'; // ë°°í¬ ëª¨ë“œ: Idle 10ë¶„, ì¥ì‹œê°„ í™œë™ 50ë¶„
      
      activityMonitorCleanup = setupActivityMonitor({
        mode: mode,
        
        onIdle: () => {
          // Idle ì½œë°±: ìºë¦­í„° ëª¨ì…˜
          if (model) {
            model.motion('Idle');
          }
          
          // ì±„íŒ…ì°½ì— ë©”ì‹œì§€ (ëª¨ë“ˆ ë¡œë“œë˜ì—ˆì„ ë•Œë§Œ)
          if (typeof window.addMessage === 'function') {
            window.addMessage('assistant', 'ì¡°ê¸ˆ ì‰¬ê³  ê³„ì‹ ê°€ìš”? ğŸ˜Š');
          } else {
            // ë©”ì‹œì§€ ì¶œë ¥ (ëª¨ë“ˆ ë¯¸ë¡œë“œ ì‹œ)
          }
        },
        
        onLongActive: () => {
          // ì¥ì‹œê°„ í™œë™ ì½œë°±: ìºë¦­í„° ëª¨ì…˜
          if (model) {
            model.motion('Tap@Body');
          }
          
          // ì±„íŒ…ì°½ì— ë©”ì‹œì§€ (ëª¨ë“ˆ ë¡œë“œë˜ì—ˆì„ ë•Œë§Œ)
          if (typeof window.addMessage === 'function') {
            window.addMessage('assistant', 'ì˜¤ë˜ ì¼í•˜ì…¨ë„¤ìš”! ì ê¹ ì¼ì–´ë‚˜ì„œ ìŠ¤íŠ¸ë ˆì¹­ ì–´ë•Œìš”? ğŸ¤¸â€â™€ï¸');
          } else {
            // ë©”ì‹œì§€ ì¶œë ¥ (ëª¨ë“ˆ ë¯¸ë¡œë“œ ì‹œ)
          }
        }
      });
    }

    /****************************************************************
     * ì±„íŒ… ë° ë¸Œë ˆì¸ìŠ¤í† ë° ì´ˆê¸°í™” (ëª¨ë“ˆì—ì„œ ì²˜ë¦¬)
     * - renderer/chat/chatUI.js
     * - renderer/brainstorming/brainstormingService.js
     * 
     * âš ï¸ ì¤‘ë³µ ë¡œì§ ì œê±°ë¨ - ëª¨ë“  ì±„íŒ… ë¡œì§ì€ chatUI.jsì—ì„œ ì²˜ë¦¬
     ****************************************************************/

    /****************************************************************
     * ìˆœì°¨ ë¡œë”
     * - ì˜ì¡´ì„± â†’ ì½”ì–´ â†’ í”ŒëŸ¬ê·¸ì¸ ìˆœì„œ ë³´ì¥
     * - CDN ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í›„ë³´ ìë™ ì‹œë„
     ****************************************************************/
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = false;               // ë¡œë“œ ìˆœì„œ ë³´ì¥(ì¤‘ìš”)
        s.onload = () => resolve();
        s.onerror = () => { console.error('âŒ ë¡œë“œ ì‹¤íŒ¨:', url); reject(new Error(url)); };
        document.head.appendChild(s);
      });
    }

    // ì „ì—­ì—ì„œ ì“¸ ì°¸ì¡°ìš© (ìŠ¤ì¼€ì¼ ì¡°ì ˆì„ ìœ„í•´)
    let app = null;
    let model = null;

    async function init() {
      try {
        /******** 1) Pixi.js (v6.x) : í”ŒëŸ¬ê·¸ì¸ 0.4.xì™€ í˜¸í™˜ ********/
        const pixiCdn = [
          'https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js',
          'https://unpkg.com/pixi.js@6.5.10/dist/browser/pixi.min.js'
        ];
        let ok = false;
        for (const url of pixiCdn) {
          try { await loadScript(url); ok = true; break; } catch {}
        }
        if (!ok) throw new Error('Pixi.js ë¡œë“œ ì‹¤íŒ¨');
        // PixiJS ë¡œë“œ ì™„ë£Œ

        /******** 2) Live2D Cubism Core : í”ŒëŸ¬ê·¸ì¸ì´ ì°¸ì¡°í•˜ëŠ” ëŸ°íƒ€ì„ ********/
        const coreCdn = [
          'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
          'https://cubism.live2d.com/sdk-web/bin/live2dcubismcore.min.js'
        ];
        ok = false;
        for (const url of coreCdn) {
          try { await loadScript(url); ok = true; break; } catch {}
        }
        if (!ok) throw new Error('Live2D Cubism Core ë¡œë“œ ì‹¤íŒ¨');
        // Live2DCubismCore ë¡œë“œ ì™„ë£Œ

        /******** 3) pixi-live2d-display (Cubism4 ë¹Œë“œ, 0.4.x) ********/
        const pluginCdn = [
          'https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.js',
          'https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.js',
          'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display@v0.4.0/dist/cubism4.js'
        ];
        ok = false;
        for (const url of pluginCdn) {
          try {
            await loadScript(url);
            if (window.PIXI?.live2d?.Live2DModel) { ok = true; break; }
          } catch {}
        }
        if (!ok) throw new Error('pixi-live2d-display (cubism4) ë¡œë“œ ì‹¤íŒ¨');

        // Live2D í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì™„ë£Œ

        /******** 4) Pixi ì•± & Live2D ëª¨ë¸ ë¡œë“œ ********/
        // ì „ì²´ ìœˆë„ìš° í¬ê¸°ë¡œ ì•± ìƒì„±
        app = new PIXI.Application({ 
          backgroundAlpha: 0,
          width: window.innerWidth,
          height: window.innerHeight,
          resizeTo: window
        });
        
        // stageì— canvas ì¶”ê°€
        const stageContainer = document.getElementById('stage');
        stageContainer.appendChild(app.view);

        const MODEL_URL = 'public/models/hiyori_free_ko/runtime/hiyori_free_t08.model3.json';
        // Stageë¥¼ interactiveë¡œ ì„¤ì •
        app.stage.interactive = true;
        app.stage.hitArea = app.screen;

        model = await PIXI.live2d.Live2DModel.from(MODEL_URL);

         // ë°°ì¹˜: í™”ë©´ ì¤‘ì•™ í•˜ë‹¨ (ë“€ì–¼ ëª¨ë‹ˆí„° ëŒ€ì‘)
         model.anchor.set(0.5, 1);
         model.scale.set(0.18); // ì´ˆê¸° í¬ê¸° (ë¨¸ë¦¬ ì•ˆ ì˜ë¦¬ë„ë¡ ì¶•ì†Œ)
         
         // ìœ„ì¹˜ ì„¤ì • (í™”ë©´ ì¤‘ì•™ ê¸°ì¤€, ìº”ë²„ìŠ¤ í¬ê¸° ê¸°ì¤€)
         const updateModelPosition = () => {
           // ìº”ë²„ìŠ¤ì˜ ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ ì¡°ê¸ˆ ì˜¤ë¥¸ìª½
           const canvasWidth = app.screen.width;
           const canvasHeight = app.screen.height;
           model.position.set(canvasWidth * 0.75, canvasHeight - 50);
           // ìºë¦­í„° ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ
         };
         updateModelPosition();
         
         // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
         window.addEventListener('resize', () => {
           updateModelPosition();
         });
         
         app.stage.addChild(model);
         // ìºë¦­í„° í™”ë©´ì— ì¶”ê°€ ì™„ë£Œ

         // Document ë ˆë²¨ ë“œë˜ê·¸ êµ¬í˜„
         let isDraggingCharacter = false;
         let dragStartMousePos = null;
         let dragStartModelPos = null;
         
         // ìºë¦­í„° ë°”ìš´ë”© ë°•ìŠ¤ ì²´í¬ í•¨ìˆ˜
         const isMouseOverCharacter = (mouseX, mouseY) => {
           const bounds = model.getBounds();
           const actualWidth = bounds.width * 0.4; // ì¢Œìš° ì¶•ì†Œ
           const widthOffset = (bounds.width - actualWidth) / 2;
           const verticalMargin = bounds.height * 0.05;
           
           return mouseX >= bounds.x + widthOffset && 
                  mouseX <= bounds.x + widthOffset + actualWidth &&
                  mouseY >= bounds.y - verticalMargin && 
                  mouseY <= bounds.y + bounds.height + verticalMargin;
         };
         
        // íŒ¨ë„ ìœ„ì— ìˆëŠ”ì§€ ì²´í¬
        const isMouseOverPanel = (clientX, clientY) => {
          const chatPanel = document.getElementById('chat-panel');
          const bsPanel = document.getElementById('brainstorming-panel');
          const modal = document.querySelector('.custom-task-modal'); // ğŸ”¥ ëª¨ë‹¬ ì¶”ê°€
          
          // ğŸ”¥ ëª¨ë‹¬ ì²´í¬ (ìµœìš°ì„ ìˆœìœ„)
          if (modal) {
            const rect = modal.getBoundingClientRect();
            if (clientX >= rect.left && clientX <= rect.right && 
                clientY >= rect.top && clientY <= rect.bottom) {
              return true;
            }
          }
          
          if (chatPanel && chatPanel.style.display !== 'none') {
            const rect = chatPanel.getBoundingClientRect();
            if (clientX >= rect.left && clientX <= rect.right && 
                clientY >= rect.top && clientY <= rect.bottom) {
              return true;
            }
          }
          
          if (bsPanel && bsPanel.style.display !== 'none') {
            const rect = bsPanel.getBoundingClientRect();
            if (clientX >= rect.left && clientX <= rect.right && 
                clientY >= rect.top && clientY <= rect.bottom) {
              return true;
            }
          }
          
          return false;
        };
         
         // Document ë ˆë²¨ ì´ë²¤íŠ¸ë¡œ ë“œë˜ê·¸ êµ¬í˜„
         document.addEventListener('mousedown', (e) => {
           // íŒ¨ë„ ìœ„ì—ì„œëŠ” ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
           if (isMouseOverPanel(e.clientX, e.clientY)) {
             return;
           }
           
           if (isMouseOverCharacter(e.clientX, e.clientY)) {
             // ë“œë˜ê·¸ ì‹œì‘
             isDraggingCharacter = true;
             dragStartMousePos = { x: e.clientX, y: e.clientY };
             dragStartModelPos = { x: model.position.x, y: model.position.y };
             e.preventDefault();
           }
         });
         
         document.addEventListener('mousemove', (e) => {
           if (isDraggingCharacter && dragStartMousePos) {
             const dx = e.clientX - dragStartMousePos.x;
             const dy = e.clientY - dragStartMousePos.y;
             
             model.position.x = dragStartModelPos.x + dx;
             model.position.y = dragStartModelPos.y + dy;
             
             // ë“œë˜ê·¸ ì¤‘
           }
         });
         
         document.addEventListener('mouseup', (e) => {
           if (isDraggingCharacter) {
             const movedDistance = Math.sqrt(
               Math.pow(e.clientX - dragStartMousePos.x, 2) + 
               Math.pow(e.clientY - dragStartMousePos.y, 2)
             );
             
             // 5px ì´í•˜ë©´ í´ë¦­ìœ¼ë¡œ ê°„ì£¼ â†’ íƒ­ ëª¨ì…˜
             if (movedDistance < 5) {
               model.motion?.('Tap');
             }
             
             isDraggingCharacter = false;
             dragStartMousePos = null;
             dragStartModelPos = null;
           }
         });

        // ì´ˆê¸°í™” ì™„ë£Œ

        // ëª¨ë¸ ì¤€ë¹„ëœ í›„ ì¸í„°ë™ì…˜ ì œì–´ ë¡œì§ ì„¸íŒ…
        setupInteractionControls();
        
        // ì±„íŒ…/ë³´ê³ ì„œ íŒ¨ë„ ì´ˆê¸°í™” (ëª¨ë“ˆ ë¡œë“œ ëŒ€ê¸°)
        const initPanels = async () => {
          // ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°
          let retries = 50;
          while (retries > 0) {
            if (typeof window.initChatPanel === 'function' && 
                typeof window.initReportPanel === 'function') {
              break;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
            retries--;
          }
          
          try {
            if (typeof window.initChatPanel === 'function') {
              window.initChatPanel();
              console.log('âœ… ì±„íŒ… íŒ¨ë„ ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
              console.error('âŒ initChatPanel í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              // ì„ì‹œ: ì±„íŒ… í† ê¸€ ë‹¨ì¶•í‚¤ ì§ì ‘ ë“±ë¡
              const chatPanel = document.getElementById('chat-panel');
              if (chatPanel) {
                let isPanelVisible = true;
                window.addEventListener('keydown', (e) => {
                  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    isPanelVisible = !isPanelVisible;
                    chatPanel.style.display = isPanelVisible ? 'flex' : 'none';
                  }
                });
              }
            }
          } catch (error) {
            console.error('âŒ ì±„íŒ… íŒ¨ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          }
          
        };
        
        initPanels();
        
        // Activity Monitor ì´ˆê¸°í™”
        setupActivityMonitorWithMotions();

      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        document.getElementById('app').innerHTML =
          `<div style="color:white;padding:20px;font-family:monospace;">
            <h2>âŒ ë¡œë“œ ì‹¤íŒ¨</h2>
            <p>${err.message}</p>
            <p>DevTools â†’ Network/Console í™•ì¸</p>
          </div>`;
      }
    }

    /****************************************************************
     * ì¸í„°ë™ì…˜ ì œì–´
     * - ìºë¦­í„° ë“œë˜ê·¸: ìºë¦­í„° ìœ„ì¹˜ ì´ë™
     * - +/- í‚¤: í¬ê¸° ì¡°ì ˆ
     * - ìºë¦­í„° ë°”ìš´ë”© ë°•ìŠ¤ë§Œ í´ë¦­ ê°€ëŠ¥ (ë™ì  ì¡°ì ˆ)
     * - ì±„íŒ… íŒ¨ë„ì€ ë³„ë„ ì²˜ë¦¬
     ****************************************************************/
    function setupInteractionControls() {
      // setupInteractionControls ì´ˆê¸°í™”
      
      let isDragging = false;
      let lastClientX = 0;
      let lastClientY = 0;

      // í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜
      const adjustScale = (delta) => {
        if (!model) return;
        const step = 0.05;
        let newScale = model.scale.x + delta * step;
        newScale = Math.max(0.1, Math.min(1.0, newScale));
        model.scale.set(newScale);
        // í¬ê¸° ì¡°ì ˆ
      };

      // í‚¤ë³´ë“œë¡œ í¬ê¸° ì¡°ì ˆ ë° ì¢…ë£Œ: +/- í‚¤, ESC í‚¤
      // ì£¼ì˜: Cmd/Ctrl + EnterëŠ” ì±„íŒ… íŒ¨ë„ì—ì„œ ì²˜ë¦¬
      window.addEventListener('keydown', (e) => {
        // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•ŒëŠ” í¬ê¸° ì¡°ì ˆ ë¹„í™œì„±í™”
        const chatInput = document.getElementById('chat-input');
        const bsInput = document.getElementById('bs-input');
        if (document.activeElement === chatInput || document.activeElement === bsInput) {
          // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ ESCë§Œ ì²˜ë¦¬
          if (e.key === 'Escape') {
            e.preventDefault();
            if (ipcRenderer) {
              ipcRenderer.send('va:request-quit');
            }
          }
          return;
        }
        
        if (e.key === '+' || e.key === '=') {
          e.preventDefault();
          adjustScale(1);
        } else if (e.key === '-' || e.key === '_') {
          e.preventDefault();
          adjustScale(-1);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          // ESC í‚¤ - ì•± ì¢…ë£Œ
          if (ipcRenderer) {
            ipcRenderer.send('va:request-quit');
          }
        }
      });

      // ìºë¦­í„° ë“œë˜ê·¸ëŠ” Document ë ˆë²¨ ì´ë²¤íŠ¸ë¡œ ì²˜ë¦¬

      // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬: ì±„íŒ… íŒ¨ë„ vs ìºë¦­í„°
      if (ipcRenderer && model) {
        let isOverCharacter = false;
        let isOverChatPanel = false;
        let isOverBsPanel = false;
        let isOverModal = false; // ğŸ”¥ ëª¨ë‹¬ ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€
        
        const checkIfOverCharacter = (clientX, clientY) => {
          if (!model) return false;
          
          // ìºë¦­í„°ì˜ ì‹¤ì œ ë°”ìš´ë”© ë°•ìŠ¤ ê°€ì ¸ì˜¤ê¸°
          const bounds = model.getBounds();
          
          // Live2D ë°”ìš´ë”© ë°•ìŠ¤ê°€ ì‹¤ì œë³´ë‹¤ ë„“ìœ¼ë¯€ë¡œ ì¢Œìš°ë¥¼ ëŒ€í­ ì¶•ì†Œ
          const actualWidth = bounds.width * 0.4;
          const widthOffset = (bounds.width - actualWidth) / 2;
          const verticalMargin = bounds.height * 0.05;
          
          return clientX >= bounds.x + widthOffset && 
                 clientX <= bounds.x + widthOffset + actualWidth &&
                 clientY >= bounds.y - verticalMargin && 
                 clientY <= bounds.y + bounds.height + verticalMargin;
        };
        
        const checkIfOverChatPanel = (clientX, clientY) => {
          const chatPanel = document.getElementById('chat-panel');
          if (!chatPanel || chatPanel.style.display === 'none') return false;
          
          const rect = chatPanel.getBoundingClientRect();
          return clientX >= rect.left && 
                 clientX <= rect.right && 
                 clientY >= rect.top && 
                 clientY <= rect.bottom;
        };
        
        // ë¸Œë ˆì¸ìŠ¤í† ë° íŒ¨ë„ ì²´í¬ í•¨ìˆ˜
        const checkIfOverBsPanel = (clientX, clientY) => {
          const bsPanel = document.getElementById('brainstorming-panel');
          if (!bsPanel || bsPanel.style.display === 'none') return false;
          
          const rect = bsPanel.getBoundingClientRect();
          return clientX >= rect.left && 
                 clientX <= rect.right && 
                 clientY >= rect.top && 
                 clientY <= rect.bottom;
        };
        
        
        // ğŸ”¥ ëª¨ë‹¬ ì²´í¬ í•¨ìˆ˜ ì¶”ê°€ (ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ìš”ì†Œ)
        const checkIfOverModal = (clientX, clientY) => {
          const modal = document.querySelector('.custom-task-modal');
          if (!modal) return false;
          
          const rect = modal.getBoundingClientRect();
          return clientX >= rect.left && 
                 clientX <= rect.right && 
                 clientY >= rect.top && 
                 clientY <= rect.bottom;
        };
        
        // ì´ˆê¸° ìƒíƒœ ì„¤ì • í•¨ìˆ˜
        const updateMouseState = (clientX, clientY) => {
          const wasOverChat = isOverChatPanel;
          const wasOverChar = isOverCharacter;
          const wasOverBs = isOverBsPanel;
          const wasOverModal = isOverModal; // ğŸ”¥ ì¶”ê°€
          
          // ğŸ”¥ ëª¨ë‹¬ ì²´í¬ (ìµœìš°ì„ ìˆœìœ„ - ê°€ì¥ ìœ„ì— í‘œì‹œë¨)
          isOverModal = checkIfOverModal(clientX, clientY);
          
          // ì±„íŒ… íŒ¨ë„ ì²´í¬ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
          isOverChatPanel = checkIfOverChatPanel(clientX, clientY);
          
          // ë¸Œë ˆì¸ìŠ¤í† ë° íŒ¨ë„ ì²´í¬ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
          isOverBsPanel = checkIfOverBsPanel(clientX, clientY);
          
          // ìºë¦­í„° ì²´í¬ (íŒ¨ë„ë“¤ê³¼ ëª¨ë‹¬ì´ ì•„ë‹ ë•Œë§Œ)
          if (!isOverChatPanel && !isOverBsPanel && !isOverModal) {
            isOverCharacter = checkIfOverCharacter(clientX, clientY);
          } else {
            isOverCharacter = false;
          }
          
          // ìƒíƒœ ë³€ê²½ ì‹œ IPC ì „ì†¡
          if (wasOverChat !== isOverChatPanel || wasOverChar !== isOverCharacter || wasOverBs !== isOverBsPanel || wasOverModal !== isOverModal) {
            const shouldAcceptClicks = isOverChatPanel || isOverBsPanel || isOverCharacter || isOverModal; // ğŸ”¥ ëª¨ë‹¬ ì¶”ê°€
            const ignoreValue = !shouldAcceptClicks;
            ipcRenderer.send('va:set-ignore-mouse', ignoreValue);
          }
        };
        
        // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
        document.addEventListener('mousemove', (e) => {
          updateMouseState(e.clientX, e.clientY);
        });
        
        // ë§ˆìš°ìŠ¤ë‹¤ìš´ ì´ë²¤íŠ¸ (í´ë¦­ ê°ì§€ìš©)
        document.addEventListener('mousedown', (e) => {
          updateMouseState(e.clientX, e.clientY);
        });
        
        // ë§ˆìš°ìŠ¤ì—… ì´ë²¤íŠ¸ (í´ë¦­ ì¢…ë£Œ ê°ì§€ìš©)
        document.addEventListener('mouseup', (e) => {
          updateMouseState(e.clientX, e.clientY);
        });
        
        // ì´ˆê¸° ìƒíƒœ ì„¤ì • (í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ í™•ì¸)
        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
        setTimeout(() => {
          // ì´ˆê¸°ì—ëŠ” ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ì„¤ì •
          // (ë§ˆìš°ìŠ¤ê°€ ì´ë™í•˜ë©´ ìë™ìœ¼ë¡œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë¨)
          if (ipcRenderer) {
            ipcRenderer.send('va:set-ignore-mouse', false);
          }
        }, 1000);
      }
    }

    // ëª¨ë“ˆ ë¡œë”©ì„ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•´ onload ì‚¬ìš©
    window.addEventListener('load', init);
  </script>
</body>
</html>
