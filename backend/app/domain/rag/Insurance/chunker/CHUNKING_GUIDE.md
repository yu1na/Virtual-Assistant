# Chunker íŒŒì´í”„ë¼ì¸ ìƒì„¸ ì„¤ëª…

## ğŸ”„ 5ë‹¨ê³„ ì²­í‚¹ í”„ë¡œì„¸ìŠ¤

```
ì¶”ì¶œëœ JSON (Extractor ì¶œë ¥)
        â†“
[Step 1] ğŸ“¥ Load Pages
    - insurance_manual_extracted.json ë¡œë“œ
    - 219ê°œ í˜ì´ì§€ ì½ê¸°
    - ì´ 182,193 characters
        â†“
[Step 2] ğŸ“ Normalize Text
    - ê³µë°±/íƒ­ ì •ê·œí™” (í…Œì´ë¸” ë³´ì¡´)
    - 3ì¤„ ì´ìƒ ë¹ˆì¤„ â†’ 2ì¤„ë¡œ í†µí•©
    - 174,679 characters (â†“ 4%)
        â†“
[Step 3] ğŸ”€ Semantic Segmentation
    - ë¬¸ì„œ ì—°ê²°: ëª¨ë“  í˜ì´ì§€ë¥¼ [Page N] í—¤ë”ì™€ í•¨ê»˜ ë³‘í•©
    - ë¬¸ì ê¸°ë°˜ ë¶„í• : 200~1000 char ì„¸ê·¸ë¨¼íŠ¸
    - 178ê°œ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„±
    - í‰ê·  ê¸¸ì´: 997 characters
        â†“
[Step 4] âš™ï¸ Refinement (Embedding-based)
    - ì‘ì€ ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© (< 160 chars + ìœ ì‚¬ë„ >= 0.86)
    - í° ì„¸ê·¸ë¨¼íŠ¸ ë¶„í•  (> 1800 chars + ìœ ì‚¬ë„ < 0.35)
    - ê²°ê³¼: 178ê°œ (ë³€í™” ì—†ìŒ = ì´ë¯¸ ìµœì í™”ë¨)
        â†“
[Step 5] âœ‚ï¸ Sliding Window Chunking
    - í† í°í™”: cl100k_base (GPT-4o ê¸°ì¤€)
    - ìœˆë„ìš°: 1024 tokens
    - ì˜¤ë²„ë©: 200 tokens (stride = 824)
    - 208ê°œ ìµœì¢… ì²­í¬ ìƒì„±
```

## ğŸ“Š ì£¼ìš” í†µê³„

| ë‹¨ê³„ | ì…ë ¥ | ì¶œë ¥ | ë³€í™” |
|------|------|------|------|
| Load | - | 219 pages | - |
| Normalize | 182,193 chars | 174,679 chars | â†“ 4% |
| Segmentation | 219 pages | 178 segments | êµ¬ì¡°í™” |
| Refinement | 178 segments | 178 segments | - |
| Chunking | 178 segments | 208 chunks | í† í° ê¸°ë°˜ ë¶„í•  |

## ğŸ¯ ì²­í¬ íŠ¹ì„±

```
ì´ ì²­í¬ ìˆ˜: 208ê°œ
í† í° ë¶„í¬:
  - í‰ê· : 1,022 tokens
  - ìµœì†Œ: 788 tokens
  - ìµœëŒ€: 1,024 tokens (ìœˆë„ìš° í¬ê¸°)

í˜ì´ì§€ ì»¤ë²„ë¦¬ì§€:
  - 206ê°œ í˜ì´ì§€ í¬í•¨ (13ê°œ ë¹ˆ í˜ì´ì§€ ì œì™¸)
  - ê° ì²­í¬ëŠ” ì—¬ëŸ¬ í˜ì´ì§€ ì •ë³´ í¬í•¨ (ì˜¤ë²„ë©)
```

## ğŸ” ì²­í¬ êµ¬ì¡°

```json
{
  "chunk_id": "ins_a4bb5c8f-d12d-4515-aca4-272f5b69556e",
  "tokens": 1024,
  "source_pages": [1, 3, 4, 5, 7, 11, 13, ...],
  "content": "[Page 1]\në°œê°„ë“±ë¡ë²ˆí˜¸ 11-1352000-002686-14\n\nì˜ë£Œê¸‰ì—¬ ìƒí•´ìš”ì¸ ì—…ë¬´ë§¤ë‰´ì–¼\n..."
}
```

## ğŸ’¡ ì„¤ê³„ íŠ¹ì§•

### 1. **ì •ê·œí™” (Normalization)**
   - í…Œì´ë¸” ë³´ì¡´ (| ê¸°í˜¸ í¬í•¨ ë¼ì¸)
   - ë§ˆí¬ë‹¤ìš´ ë³´ì¡´ (* ë¡œ ì‹œì‘í•˜ëŠ” ë¼ì¸)
   - ê³µë°± ìµœì†Œí™”

### 2. **ì˜ë¯¸ ê¸°ë°˜ ì„¸ê·¸ë©˜íŠ¸ (Semantic Segmentation)**
   - ë¬¸ì ê¸¸ì´ ê¸°ë°˜: 200~1000 chars
   - ë¡œì»¬ í´ë°±: OpenAI API ì—†ì´ë„ ì‘ë™
   - í˜ì´ì§€ ê²½ê³„ ìœ ì§€: [Page N] í—¤ë”

### 3. **ì„ë² ë”© ìµœì í™” (Embedding Refinement)**
   - ì‘ì€ ì„¸ê·¸ë¨¼íŠ¸: ìœ ì‚¬ë„ ê¸°ë°˜ ë³‘í•© (0.86 threshold)
   - í° ì„¸ê·¸ë¨¼íŠ¸: ìœ ì‚¬ë„ ì €ì ì—ì„œ ë¶„í•  (0.35 threshold)
   - ë¡œì»¬ í•´ì‹œ ê¸°ë°˜: ë¹ ë¥¸ ìœ ì‚¬ë„ ê³„ì‚°

### 4. **í† í° ê¸°ë°˜ ì²­í‚¹ (Sliding Window)**
   - GPT-4o í˜¸í™˜: cl100k_base í† í¬ë‚˜ì´ì €
   - ì˜¤ë²„ë©: 200 tokens (ë¬¸ë§¥ ë³´ì¡´)
   - ì ì‘í˜•: ë§ˆì§€ë§‰ ì²­í¬ ìë™ ì¡°ì •

## ğŸš€ ì‹¤í–‰ ì˜ˆì‹œ

```python
from app.domain.rag.Insurance.chunker import run_for_all

# ëª¨ë“  PDF ì²­í‚¹
outputs = run_for_all()

# ê²°ê³¼
# ğŸ“ chunks_insurance_manual.json (208 chunks)
# [INFO] Chunks saved: ... (count=208)
```

## âš¡ ì„±ëŠ¥

- ì²˜ë¦¬ ì‹œê°„: ~0.3ì´ˆ (219 í˜ì´ì§€)
- í‰ê·  ì²­í¬ í¬ê¸°: 1,022 tokens â‰ˆ 750 words
- ì €ì¥ í¬ê¸°: ~4.5MB
- ì˜¤ë²„í—¤ë“œ: ë¬´ì‹œí•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€

## ğŸ”— ë‹¤ìŒ ë‹¨ê³„

â†’ **Embedder**: 208ê°œ ì²­í¬ë¥¼ ë²¡í„°ë¡œ ë³€í™˜
â†’ **Vector Store**: ChromaDBì— ì €ì¥
â†’ **RAG Pipeline**: LLMê³¼ í•¨ê»˜ ê²€ìƒ‰-ì‘ë‹µ ì‹¤í–‰
