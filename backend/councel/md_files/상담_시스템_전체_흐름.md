# ìƒë‹´ ì‹œìŠ¤í…œ ì „ì²´ íë¦„ ë° êµ¬ì¡° ë¬¸ì„œ

## ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì„œë²„ ì‹œì‘ í”„ë¡œì„¸ìŠ¤](#ì„œë²„-ì‹œì‘-í”„ë¡œì„¸ìŠ¤)
3. [ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
4. [ì‚¬ìš©ì ìš”ì²­ ì²˜ë¦¬ íë¦„](#ì‚¬ìš©ì-ìš”ì²­-ì²˜ë¦¬-íë¦„)
5. [ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ì„¤ëª…](#ì£¼ìš”-ì»´í¬ë„ŒíŠ¸-ìƒì„¸-ì„¤ëª…)
6. [ê¸°ìˆ  ìŠ¤íƒ ë° ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬](#ê¸°ìˆ -ìŠ¤íƒ-ë°-ì‚¬ìš©-ë¼ì´ë¸ŒëŸ¬ë¦¬)

---

## ì‹œìŠ¤í…œ ê°œìš”

ì´ ë¬¸ì„œëŠ” ì„œë²„ ì‹œì‘ë¶€í„° í”„ë¡ íŠ¸ì—”ë“œ ì¶œë ¥ê¹Œì§€ì˜ ì „ì²´ ìƒë‹´ ì‹œìŠ¤í…œ íë¦„ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ì‹œìŠ¤í…œì€ RAG(Retrieval-Augmented Generation) ê¸°ë°˜ ì•„ë“¤ëŸ¬ ê°œì¸ì‹¬ë¦¬í•™ ìƒë‹´ ì‹œìŠ¤í…œìœ¼ë¡œ, Vector DBë¥¼ í™œìš©í•œ ì§€ì‹ ê²€ìƒ‰ê³¼ LLM ê¸°ë°˜ ë‹µë³€ ìƒì„±ì„ ê²°í•©í•©ë‹ˆë‹¤.

### í•µì‹¬ íŠ¹ì§•

- **RAG ê¸°ë°˜ ìƒë‹´**: Vector DBì—ì„œ ê´€ë ¨ ìë£Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ë‹µë³€ ìƒì„±
- **Threshold ê¸°ë°˜ ë¶„ê¸°**: ìœ ì‚¬ë„ì— ë”°ë¼ LLM ë‹¨ë… ë˜ëŠ” RAG ëª¨ë“œ ì„ íƒ
- **Self-learning**: ë‚®ì€ ìœ ì‚¬ë„ì¼ ë•Œ Q&Aë¥¼ ìë™ìœ¼ë¡œ Vector DBì— ì €ì¥
- **Multi-step ê²€ìƒ‰**: ì¿¼ë¦¬ í™•ì¥ì„ í†µí•œ ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ
- **ë™ì  í˜ë¥´ì†Œë‚˜**: Vector DBì™€ ì›¹ ê²€ìƒ‰ì„ í†µí•œ ì•„ë“¤ëŸ¬ í˜ë¥´ì†Œë‚˜ ìƒì„±

---

## ì„œë²„ ì‹œì‘ í”„ë¡œì„¸ìŠ¤

### 1. ì„œë²„ ì‹œì‘ ìˆœì„œë„

```
ì‹œì‘
  â†“
FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„± (main.py)
  â†“
lifespan í•¨ìˆ˜ ì‹¤í–‰ (ì„œë²„ ì‹œì‘ ì‹œ)
  â†“
ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„±
  â†“
Vector DB ìë™ ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘
  â”œâ”€ automatic_save() í˜¸ì¶œ
  â”‚   â”œâ”€ Step 1: ì²­í¬ íŒŒì¼ ìƒì„±
  â”‚   â”œâ”€ Step 2: ì„ë² ë”© íŒŒì¼ ìƒì„±
  â”‚   â””â”€ Step 3: Vector DB ì €ì¥
  â”‚
  â””â”€ ìƒë‹´ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      â”œâ”€ TherapyService ì‹±ê¸€í†¤ ìƒì„±
      â””â”€ RAGTherapySystem ì´ˆê¸°í™”
          â”œâ”€ ChromaDB í´ë¼ì´ì–¸íŠ¸ ì—°ê²°
          â”œâ”€ PersonaManager ì´ˆê¸°í™”
          â”œâ”€ SearchEngine ì´ˆê¸°í™”
          â””â”€ ResponseGenerator ì´ˆê¸°í™”
  â†“
ì„œë²„ ì¤€ë¹„ ì™„ë£Œ
```

### 2. ìë™ ì €ì¥ í”„ë¡œì„¸ìŠ¤ (automatic_save)

#### 2.1 AutomaticSaveManager í´ë˜ìŠ¤

**ìœ„ì¹˜**: `backend/councel/sourcecode/automatic_save.py`

**ì—­í• **: PDF íŒŒì¼ì„ Vector DBë¡œ ë³€í™˜í•˜ëŠ” ì „ì²´ í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `step1_create_chunks()` | PDF íŒŒì¼ì„ ì²­í¬ë¡œ ë¶„í• í•˜ì—¬ JSON íŒŒì¼ ìƒì„± |
| `step2_create_embeddings()` | ì²­í¬ íŒŒì¼ì— ëŒ€í•œ ì„ë² ë”© ìƒì„± |
| `step3_save_to_vectordb()` | ì„ë² ë”©ì„ ChromaDBì— ì €ì¥ |
| `run()` | ì „ì²´ í”„ë¡œì„¸ìŠ¤ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ |

**ì‹¤í–‰ íë¦„**:

```
automatic_save()
  â†“
Step 1: ì²­í¬ íŒŒì¼ ìƒì„± í™•ì¸
  â”œâ”€ chunkfiles í´ë” ì¡´ì¬ í™•ì¸
  â”œâ”€ ê¸°ì¡´ íŒŒì¼ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
  â””â”€ ì—†ìœ¼ë©´ create_chunk_files.py ì‹¤í–‰
  â†“
Step 2: ì„ë² ë”© íŒŒì¼ ìƒì„± í™•ì¸
  â”œâ”€ embeddings í´ë” ì¡´ì¬ í™•ì¸
  â”œâ”€ ê¸°ì¡´ íŒŒì¼ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
  â””â”€ ì—†ìœ¼ë©´ create_openai_embeddings.py ì‹¤í–‰
  â†“
Step 3: Vector DB ì €ì¥ í™•ì¸
  â”œâ”€ vector_db í´ë” ì¡´ì¬ í™•ì¸
  â”œâ”€ ì»¬ë ‰ì…˜ ë°ì´í„° í™•ì¸
  â”œâ”€ ê¸°ì¡´ ë°ì´í„° ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
  â””â”€ ì—†ìœ¼ë©´ save_to_vectordb.py ì‹¤í–‰
  â†“
ì™„ë£Œ
```

#### 2.2 ì²­í¬ íŒŒì¼ ìƒì„± (create_chunk_files.py)

**ìœ„ì¹˜**: `backend/councel/sourcecode/automatic_save/create_chunk_files.py`

**ê¸°ëŠ¥**: PDF íŒŒì¼ì„ Parent-Child êµ¬ì¡°ë¡œ ì²­í‚¹

**ì£¼ìš” íŠ¹ì§•**:
- **Parent ì²­í¬**: 1000 tokens
- **Child ì²­í¬**: 500 tokens
- **Overlap**: 20% (0.2)

**ì²˜ë¦¬ ê³¼ì •**:

```
PDF íŒŒì¼ ì½ê¸° (PyMuPDF)
  â†“
í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° ì •ì œ
  â”œâ”€ í˜ì´ì§€ ë²ˆí˜¸ ì œê±°
  â”œâ”€ í‘œ/ê·¸ë˜í”„ íŠ¹ìˆ˜ë¬¸ì ì œê±°
  â”œâ”€ ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜ ì œê±°
  â”œâ”€ URL/ì´ë©”ì¼ ì œê±°
  â””â”€ ê³µë°± ì •ë¦¬
  â†“
Parent-Child ì²­í‚¹
  â”œâ”€ Parent: 1000 tokens
  â””â”€ Child: 500 tokens (overlap 20%)
  â†“
ë©”íƒ€ë°ì´í„° ì¶”ê°€
  â”œâ”€ source: íŒŒì¼ëª…
  â”œâ”€ chunk_type: "parent" ë˜ëŠ” "child"
  â”œâ”€ parent_id: Parent ì²­í¬ ID (Childë§Œ)
  â””â”€ page_number: í˜ì´ì§€ ë²ˆí˜¸
  â†“
JSON íŒŒì¼ë¡œ ì €ì¥ (*_chunks.json)
```

**ì‚¬ìš© ê¸°ìˆ **:
- `PyMuPDF (fitz)`: PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ
- `tiktoken`: í† í° ìˆ˜ ê³„ì‚°

#### 2.3 ì„ë² ë”© ìƒì„± (create_openai_embeddings.py)

**ìœ„ì¹˜**: `backend/councel/sourcecode/automatic_save/create_openai_embeddings.py`

**ê¸°ëŠ¥**: ì²­í¬ íŒŒì¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ì„ë² ë”© ë²¡í„°ë¡œ ë³€í™˜

**ì²˜ë¦¬ ê³¼ì •**:

```
ì²­í¬ íŒŒì¼ ë¡œë“œ (*_chunks.json)
  â†“
ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì„ë² ë”© ìƒì„±
  â”œâ”€ ëª¨ë¸: text-embedding-3-large
  â”œâ”€ ë°°ì¹˜ í¬ê¸°: 100ê°œ
  â””â”€ OpenAI API í˜¸ì¶œ
  â†“
ì„ë² ë”©ì„ ì²­í¬ì— ì¶”ê°€
  â†“
JSON íŒŒì¼ë¡œ ì €ì¥ (*_embeddings.json)
```

**ì‚¬ìš© ê¸°ìˆ **:
- `OpenAI API`: ì„ë² ë”© ìƒì„±
- `tqdm`: ì§„í–‰ë¥  í‘œì‹œ

#### 2.4 Vector DB ì €ì¥ (save_to_vectordb.py)

**ìœ„ì¹˜**: `backend/councel/sourcecode/automatic_save/save_to_vectordb.py`

**ê¸°ëŠ¥**: ì„ë² ë”© íŒŒì¼ì„ ChromaDBì— ì €ì¥

**ì²˜ë¦¬ ê³¼ì •**:

```
ChromaDB í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
  â†“
ì»¬ë ‰ì…˜ ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
  â”œâ”€ ì»¬ë ‰ì…˜ëª…: "vector_adler"
  â””â”€ ê±°ë¦¬ í•¨ìˆ˜: cosine (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
  â†“
ì„ë² ë”© íŒŒì¼ ë¡œë“œ
  â†“
ê¸°ì¡´ ID í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
  â†“
ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì €ì¥ (ë°°ì¹˜ í¬ê¸°: 1000)
  â”œâ”€ ids: ê³ ìœ  ID
  â”œâ”€ embeddings: ì„ë² ë”© ë²¡í„°
  â”œâ”€ documents: ì›ë³¸ í…ìŠ¤íŠ¸
  â””â”€ metadatas: ë©”íƒ€ë°ì´í„°
  â†“
ì €ì¥ ì™„ë£Œ
```

**ì‚¬ìš© ê¸°ìˆ **:
- `ChromaDB`: ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤
- `cosine` ê±°ë¦¬ í•¨ìˆ˜: ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê¸°ë°˜ ê²€ìƒ‰

---

## ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ë ˆì´ì–´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         í”„ë¡ íŠ¸ì—”ë“œ ë ˆì´ì–´               â”‚
â”‚  (renderer/chat/chatPanel.js)           â”‚
â”‚  - ì‚¬ìš©ì ì…ë ¥ UI                       â”‚
â”‚  - ë©”ì‹œì§€ í‘œì‹œ UI                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†• HTTP/JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API ë ˆì´ì–´                      â”‚
â”‚  (app/api/v1/endpoints/therapy.py)      â”‚
â”‚  - ìš”ì²­/ì‘ë‹µ ê²€ì¦                       â”‚
â”‚  - HTTP ìƒíƒœ ì½”ë“œ ì²˜ë¦¬                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ì„œë¹„ìŠ¤ ë ˆì´ì–´                   â”‚
â”‚  (app/domain/therapy/service.py)        â”‚
â”‚  - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§                        â”‚
â”‚  - ì‹±ê¸€í†¤ íŒ¨í„´ ê´€ë¦¬                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ì½”ì–´ ë ˆì´ì–´                     â”‚
â”‚  (councel/sourcecode/persona/)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ RAGTherapySystem                â”‚   â”‚
â”‚  â”‚  - ì „ì²´ ìƒë‹´ í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ PersonaManager                  â”‚   â”‚
â”‚  â”‚  - í˜ë¥´ì†Œë‚˜ ìƒì„± ë° ìºì‹±        â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ SearchEngine                    â”‚   â”‚
â”‚  â”‚  - Vector DB ê²€ìƒ‰               â”‚   â”‚
â”‚  â”‚  - ìœ ì‚¬ë„ ê³„ì‚°                  â”‚   â”‚
â”‚  â”‚  - ì¿¼ë¦¬ í™•ì¥                    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ResponseGenerator               â”‚   â”‚
â”‚  â”‚  - ë‹µë³€ ìƒì„±                    â”‚   â”‚
â”‚  â”‚  - ì…ë ¥ ë¶„ë¥˜                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ë°ì´í„° ë ˆì´ì–´                   â”‚
â”‚  - ChromaDB (Vector DB)                 â”‚
â”‚  - ì»¬ë ‰ì…˜: vector_adler                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë°ì´í„° íë¦„

```
ì‚¬ìš©ì ì…ë ¥
  â†“
í”„ë¡ íŠ¸ì—”ë“œ í‚¤ì›Œë“œ ê°ì§€
  â†“
API ì—”ë“œí¬ì¸íŠ¸ (POST /api/v1/therapy/chat)
  â†“
ì„œë¹„ìŠ¤ ë ˆì´ì–´ (TherapyService)
  â†“
ìƒë‹´ ì‹œìŠ¤í…œ (RAGTherapySystem.chat())
  â”œâ”€ ì…ë ¥ ë¶„ë¥˜
  â”œâ”€ ë²ˆì—­ (í•œêµ­ì–´ â†’ ì˜ì–´)
  â”œâ”€ ê²€ìƒ‰ (SearchEngine)
  â”‚   â”œâ”€ ì„ë² ë”© ìƒì„±
  â”‚   â”œâ”€ Vector DB ê²€ìƒ‰
  â”‚   â”œâ”€ ìœ ì‚¬ë„ ê³„ì‚°
  â”‚   â””â”€ Re-ranker ì ìš©
  â”œâ”€ Threshold ë¶„ê¸°
  â”‚   â”œâ”€ ìœ ì‚¬ë„ â‰¥ 0.7: LLM ë‹¨ë… ë‹µë³€
  â”‚   â””â”€ ìœ ì‚¬ë„ < 0.7: RAG + Self-learning
  â”œâ”€ ë‹µë³€ ìƒì„± (ResponseGenerator)
  â””â”€ Self-learning (í•„ìš” ì‹œ)
  â†“
ì‘ë‹µ ë°˜í™˜
  â†“
í”„ë¡ íŠ¸ì—”ë“œ ì¶œë ¥
```

---

## ì‚¬ìš©ì ìš”ì²­ ì²˜ë¦¬ íë¦„

### ì „ì²´ íë¦„ë„

```
[í”„ë¡ íŠ¸ì—”ë“œ] ì‚¬ìš©ì ì…ë ¥
  â”‚
  â”œâ”€ chatPanel.js: handleSendMessage()
  â”‚   â””â”€ ì‚¬ìš©ì ë©”ì‹œì§€ UIì— ì¶”ê°€
  â”‚
  â””â”€ chatService.js: callChatModule()
      â”‚
      â”œâ”€ í‚¤ì›Œë“œ ê°ì§€ (isTherapyRelated)
      â”‚   â””â”€ ìƒë‹´ í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸
      â”‚
      â””â”€ [í‚¤ì›Œë“œ ê°ì§€ ì‹œ]
          â”‚
          â””â”€ sendTherapyMessage()
              â”‚
              â””â”€ HTTP POST /api/v1/therapy/chat
                  â”‚
                  â””â”€ [ë°±ì—”ë“œ] therapy.py: chat_therapy()
                      â”‚
                      â”œâ”€ TherapyService.is_available() í™•ì¸
                      â”‚
                      â””â”€ TherapyService.chat()
                          â”‚
                          â””â”€ RAGTherapySystem.chat()
                              â”‚
                              â”œâ”€ 1. ì¢…ë£Œ í‚¤ì›Œë“œ í™•ì¸
                              â”‚
                              â”œâ”€ 2. ì…ë ¥ ë¶„ë¥˜ (ResponseGenerator)
                              â”‚   â””â”€ adler / counseling / general
                              â”‚
                              â”œâ”€ 3. ì˜ì–´ ë²ˆì—­ (SearchEngine)
                              â”‚
                              â”œâ”€ 4. Multi-step ê²€ìƒ‰
                              â”‚   â”œâ”€ ì´ˆê¸° ê²€ìƒ‰
                              â”‚   â”œâ”€ í’ˆì§ˆ í‰ê°€
                              â”‚   â”œâ”€ ì¿¼ë¦¬ í™•ì¥ (í•„ìš” ì‹œ)
                              â”‚   â”œâ”€ ì¬ê²€ìƒ‰
                              â”‚   â””â”€ Re-ranker ì ìš©
                              â”‚
                              â”œâ”€ 5. ìµœê³  ìœ ì‚¬ë„ ê³„ì‚°
                              â”‚
                              â”œâ”€ 6. Threshold ë¶„ê¸° (0.7)
                              â”‚   â”‚
                              â”‚   â”œâ”€ [ìœ ì‚¬ë„ â‰¥ 0.7]
                              â”‚   â”‚   â””â”€ LLM ë‹¨ë… ë‹µë³€ ìƒì„±
                              â”‚   â”‚       â””â”€ ResponseGenerator._generate_llm_only_response()
                              â”‚   â”‚
                              â”‚   â””â”€ [ìœ ì‚¬ë„ < 0.7]
                              â”‚       â”œâ”€ RAG ê¸°ë°˜ ë‹µë³€ ìƒì„±
                              â”‚       â”‚   â””â”€ ResponseGenerator.generate_response_with_persona()
                              â”‚       â””â”€ Self-learning (Q&A ì €ì¥)
                              â”‚           â””â”€ _save_qa_to_vectordb()
                              â”‚
                              â”œâ”€ 7. ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
                              â”‚
                              â””â”€ ì‘ë‹µ ë”•ì…”ë„ˆë¦¬ ë°˜í™˜
                                  â”‚
                                  â””â”€ [ì‘ë‹µ ë°˜í™˜ ê²½ë¡œ]
                                      â”‚
                                      â””â”€ TherapyService â†’ therapy.py
                                          â”‚
                                          â””â”€ TherapyResponse ìƒì„±
                                              â”‚
                                              â””â”€ [í”„ë¡ íŠ¸ì—”ë“œ] chatService.js
                                                  â”‚
                                                  â””â”€ chatPanel.js: addTherapyMessage()
                                                      â”‚
                                                      â””â”€ UIì— ë©”ì‹œì§€ í‘œì‹œ
```

### ìƒì„¸ ë‹¨ê³„ ì„¤ëª…

#### Step 1: í”„ë¡ íŠ¸ì—”ë“œ ì…ë ¥ ì²˜ë¦¬

**íŒŒì¼**: `renderer/chat/chatPanel.js`

**ì²˜ë¦¬ ë‚´ìš©**:
1. ì‚¬ìš©ìê°€ ì…ë ¥ì°½ì— ë©”ì‹œì§€ ì…ë ¥
2. Enter í‚¤ ë˜ëŠ” ì „ì†¡ ë²„íŠ¼ í´ë¦­
3. `handleSendMessage()` í•¨ìˆ˜ ì‹¤í–‰
4. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ UIì— ì¦‰ì‹œ í‘œì‹œ
5. `callChatModule()` í˜¸ì¶œ

**ì½”ë“œ ìœ„ì¹˜**:
```javascript
// chatPanel.js
async function handleSendMessage() {
  const text = chatInput.value.trim();
  addMessage('user', text);  // ì‚¬ìš©ì ë©”ì‹œì§€ UI ì¶”ê°€
  const response = await callChatModule(text);  // ë°±ì—”ë“œ í˜¸ì¶œ
  // ì‘ë‹µ ì²˜ë¦¬...
}
```

#### Step 2: í‚¤ì›Œë“œ ê°ì§€ ë° ë¼ìš°íŒ…

**íŒŒì¼**: `renderer/chat/chatService.js`

**ì²˜ë¦¬ ë‚´ìš©**:
1. `isTherapyRelated()` í•¨ìˆ˜ë¡œ ìƒë‹´ í‚¤ì›Œë“œ í™•ì¸
2. í‚¤ì›Œë“œ ê°ì§€ ì‹œ `sendTherapyMessage()` í˜¸ì¶œ
3. HTTP POST ìš”ì²­ ìƒì„±

**í‚¤ì›Œë“œ ëª©ë¡** (ì¼ë¶€):
- í˜ë“¤ì–´, ìƒë‹´, ì§œì¦, ìš°ìš¸, ë¶ˆì•ˆ, ìŠ¤íŠ¸ë ˆìŠ¤
- ì•„ë“¤ëŸ¬, adler, counseling, therapy
- ê³ ë¯¼, ê±±ì •, ìŠ¬í”„, ì™¸ë¡œ, í™”ë‚˜

**ì½”ë“œ ìœ„ì¹˜**:
```javascript
// chatService.js
function isTherapyRelated(text) {
  const therapyKeywords = [/* í‚¤ì›Œë“œ ëª©ë¡ */];
  return therapyKeywords.some(keyword => lowerText.includes(keyword));
}

async function sendTherapyMessage(userText) {
  const response = await fetch(`${API_BASE_URL}/therapy/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: userText })
  });
  // ...
}
```

#### Step 3: API ì—”ë“œí¬ì¸íŠ¸ ì²˜ë¦¬

**íŒŒì¼**: `backend/app/api/v1/endpoints/therapy.py`

**ì²˜ë¦¬ ë‚´ìš©**:
1. `TherapyRequest` ëª¨ë¸ë¡œ ìš”ì²­ ê²€ì¦
2. `TherapyService` ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
3. ì„œë¹„ìŠ¤ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
4. `TherapyService.chat()` í˜¸ì¶œ
5. `TherapyResponse` ëª¨ë¸ë¡œ ì‘ë‹µ ë°˜í™˜

**API ìŠ¤í™**:
- **ì—”ë“œí¬ì¸íŠ¸**: `POST /api/v1/therapy/chat`
- **ìš”ì²­ ë³¸ë¬¸**: `{ "message": string, "enable_scoring": boolean }`
- **ì‘ë‹µ**: `{ "answer": string, "mode": string, "used_chunks": string[], "continue_conversation": boolean }`

#### Step 4: ì„œë¹„ìŠ¤ ë ˆì´ì–´

**íŒŒì¼**: `backend/app/domain/therapy/service.py`

**ì²˜ë¦¬ ë‚´ìš©**:
1. ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬
2. `RAGTherapySystem` ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒ)
3. `RAGTherapySystem.chat()` í˜¸ì¶œ
4. ì˜ˆì™¸ ì²˜ë¦¬ ë° ì—ëŸ¬ ì‘ë‹µ ìƒì„±

**ì´ˆê¸°í™” ê³¼ì •**:
- Vector DB ê²½ë¡œ ì„¤ì •
- `RAGTherapySystem` ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- ChromaDB ì—°ê²° ë° ì»¬ë ‰ì…˜ ë¡œë“œ

#### Step 5: ìƒë‹´ ì‹œìŠ¤í…œ ì²˜ë¦¬

**íŒŒì¼**: `backend/councel/sourcecode/persona/rag_therapy.py`

**ì£¼ìš” ì²˜ë¦¬ ë‹¨ê³„**:

1. **ì¢…ë£Œ í‚¤ì›Œë“œ í™•ì¸**
   - í‚¤ì›Œë“œ: "exit", "ê³ ë§ˆì›Œ", "ë"
   - ì¢…ë£Œ ë©”ì‹œì§€ ë°˜í™˜

2. **ì…ë ¥ ë¶„ë¥˜**
   - `ResponseGenerator.classify_input()`
   - ë°˜í™˜: "adler" / "counseling" / "general"

3. **ì˜ì–´ ë²ˆì—­**
   - `SearchEngine.translate_to_english()`
   - Vector DB ê²€ìƒ‰ìš© ì˜ì–´ ì¿¼ë¦¬ ìƒì„±

4. **Multi-step ê²€ìƒ‰**
   - `SearchEngine._iterative_search_with_query_expansion()`
   - ìµœëŒ€ 2íšŒ ë°˜ë³µ (ì´ˆê¸° ê²€ìƒ‰ + ì¿¼ë¦¬ í™•ì¥ ê²€ìƒ‰)
   - í’ˆì§ˆ í‰ê°€ ë° ê°œì„ 

5. **ìœ ì‚¬ë„ ê³„ì‚°**
   - ê²€ìƒ‰ëœ ì²­í¬ë“¤ì˜ ìµœê³  ìœ ì‚¬ë„ ì¶”ì¶œ
   - ê°ì • ê°€ì¤‘ì¹˜ ì ìš©ëœ `final_similarity` ì‚¬ìš©

6. **Threshold ë¶„ê¸° (0.7 ê¸°ì¤€)**
   - **Case A**: ìœ ì‚¬ë„ â‰¥ 0.7
     - LLM ë‹¨ë… ëª¨ë“œ
     - RAG ì—†ì´ í˜ë¥´ì†Œë‚˜ ê¸°ë°˜ ë‹µë³€
   - **Case B**: ìœ ì‚¬ë„ < 0.7
     - RAG ëª¨ë“œ
     - ê²€ìƒ‰ëœ ì²­í¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©
     - Self-learning ì‹¤í–‰ (ìœ ì‚¬ë„ < 0.7ì¼ ë•Œ)

7. **ë‹µë³€ ìƒì„±**
   - LLM ë‹¨ë…: `ResponseGenerator._generate_llm_only_response()`
   - RAG ê¸°ë°˜: `ResponseGenerator.generate_response_with_persona()`

8. **ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸**
   - ìµœëŒ€ 10ê°œ ëŒ€í™” ìœ ì§€
   - ì˜¤ë˜ëœ ëŒ€í™” ìë™ ì œê±°

#### Step 6: ê²€ìƒ‰ í”„ë¡œì„¸ìŠ¤ ìƒì„¸

**íŒŒì¼**: `backend/councel/sourcecode/persona/search_engine.py`

**Multi-step ê²€ìƒ‰ íë¦„**:

```
ì´ˆê¸° ê²€ìƒ‰
  â”œâ”€ ì„ë² ë”© ìƒì„± (text-embedding-3-large)
  â”œâ”€ Vector DB ê²€ìƒ‰ (n_results=5)
  â””â”€ í’ˆì§ˆ í‰ê°€
      â”œâ”€ í‰ê·  ìœ ì‚¬ë„ ê³„ì‚°
      â”œâ”€ ë‹¤ì–‘ì„± ì ìˆ˜ ê³„ì‚° (ì„œë¡œ ë‹¤ë¥¸ ì†ŒìŠ¤ ë¹„ìœ¨)
      â””â”€ ì¢…í•© í’ˆì§ˆ ì ìˆ˜ (í‰ê·  ìœ ì‚¬ë„ 70% + ë‹¤ì–‘ì„± 30%)
      â†“
[í’ˆì§ˆ ì ìˆ˜ < 0.6ì´ë©´ ê°œì„  ì‹œë„]
  â”œâ”€ ì¿¼ë¦¬ í™•ì¥ (LLM ê¸°ë°˜)
  â”‚   â”œâ”€ í•µì‹¬ ê°ì •/ì‹¬ë¦¬ ìƒíƒœ ì¶”ì¶œ
  â”‚   â”œâ”€ ì•„ë“¤ëŸ¬ ê°œë… ì—°ê²°
  â”‚   â””â”€ ìœ ì‚¬í•œ ìƒí™© í‚¤ì›Œë“œ ìƒì„±
  â”œâ”€ í™•ì¥ëœ ì¿¼ë¦¬ë¡œ ì¬ê²€ìƒ‰
  â””â”€ ê²°ê³¼ ë³‘í•©
      â†“
Re-ranker ì ìš©
  â”œâ”€ LLM ê¸°ë°˜ ê´€ë ¨ì„± í‰ê°€
  â””â”€ ì¬ì •ë ¬
      â†“
ìµœì¢… ìƒìœ„ 5ê°œ ì²­í¬ ë°˜í™˜
```

**ê²€ìƒ‰ ê¸°ëŠ¥**:
- **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**: ë²¡í„° ê²€ìƒ‰ + ê°ì • í‚¤ì›Œë“œ ê°€ì¤‘ì¹˜
- **ê°ì • ê°€ì¤‘ì¹˜**: ì‚¬ìš©ì ì…ë ¥ê³¼ ì²­í¬ì˜ ê°ì • í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ ìœ ì‚¬ë„ ë³´ë„ˆìŠ¤ (ìµœëŒ€ +0.2)
- **ìœ ì‚¬ë„ ë³€í™˜**: L2 distance â†’ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ (0~1)

#### Step 7: ë‹µë³€ ìƒì„± í”„ë¡œì„¸ìŠ¤

**íŒŒì¼**: `backend/councel/sourcecode/persona/response_generator.py`

**LLM ë‹¨ë… ëª¨ë“œ**:
1. í˜ë¥´ì†Œë‚˜ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
2. ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¶”ê°€ (ìµœê·¼ 3ê°œ)
3. ê°ì • ë§¥ë½ ì¶”ì¶œ
4. 3ë‹¨ê³„ êµ¬ì¡° ê°•ì œ í”„ë¡¬í”„íŠ¸
5. OpenAI API í˜¸ì¶œ (gpt-4o-mini)

**RAG ê¸°ë°˜ ëª¨ë“œ**:
1. ê²€ìƒ‰ëœ ì²­í¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ êµ¬ì„± (ìƒìœ„ 3ê°œ)
2. í˜ë¥´ì†Œë‚˜ í”„ë¡¬í”„íŠ¸ ì ìš©
3. ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¶”ê°€ (ìµœê·¼ 10ê°œ)
4. ê°ì • í‚¤ì›Œë“œ ê°ì§€ ë° ë°˜ì˜
5. 3ë‹¨ê³„ êµ¬ì¡° í”„ë¡¬í”„íŠ¸:
   - 1ë‹¨ê³„: ê°ì • ì¸ì • (1ë¬¸ì¥)
   - 2ë‹¨ê³„: ì•„ë“¤ëŸ¬ ê´€ì  ì¬í•´ì„ (1ë¬¸ì¥)
   - 3ë‹¨ê³„: ê²©ë ¤ ë° ì‹¤ì²œ ë°©ì•ˆ (1~2ë¬¸ì¥)
6. OpenAI API í˜¸ì¶œ (gpt-4o-mini, max_tokens=250)

#### Step 8: Self-learning

**íŒŒì¼**: `backend/councel/sourcecode/persona/rag_therapy.py`

**ì¡°ê±´**: ìµœê³  ìœ ì‚¬ë„ < 0.7ì¼ ë•Œ ì‹¤í–‰

**ì²˜ë¦¬ ê³¼ì •**:
1. ì‚¬ìš©ì ì§ˆë¬¸ê³¼ LLM ë‹µë³€ì„ JSON ë¬¸ì„œë¡œ êµ¬ì„±
2. ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ì„ë² ë”© ìƒì„±
3. Vector DBì— ì €ì¥
   - ID: `self_learning_{uuid}`
   - ë©”íƒ€ë°ì´í„°: `source: "self_learning"`, `type: "qa_pair"`

**ëª©ì **: ìœ ì‚¬ ì§ˆë¬¸ì´ ë‹¤ì‹œ ë“¤ì–´ì˜¬ ë•Œ ë” ë‚˜ì€ ë‹µë³€ ì œê³µ

#### Step 9: ì‘ë‹µ ë°˜í™˜ ë° í”„ë¡ íŠ¸ì—”ë“œ ì¶œë ¥

**ì‘ë‹µ í˜•ì‹**:
```python
{
    "answer": "ë‹µë³€ í…ìŠ¤íŠ¸",
    "used_chunks": ["ì¶œì²˜: ì²­í¬ ë¯¸ë¦¬ë³´ê¸°..."],
    "used_chunks_detailed": [
        {
            "chunk_id": "...",
            "source": "ì¶œì²˜",
            "summary_kr": "ìš”ì•½",
            "similarity": 0.85
        }
    ],
    "mode": "adler" | "counseling" | "general" | "llm_only",
    "continue_conversation": True,
    "similarity_score": 0.75,
    "search_iterations": 2
}
```

**í”„ë¡ íŠ¸ì—”ë“œ ì¶œë ¥**:
- `chatPanel.js`ì˜ `addTherapyMessage()` í•¨ìˆ˜
- ì•„ë“¤ëŸ¬ ì•„ì´ì½˜(ğŸ­)ê³¼ í•¨ê»˜ ë©”ì‹œì§€ í‘œì‹œ
- íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ë§ ì ìš© (therapy-bubble)

---

## ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ì„¤ëª…

### 1. RAGTherapySystem

**íŒŒì¼**: `backend/councel/sourcecode/persona/rag_therapy.py`

**ì—­í• **: ì „ì²´ ìƒë‹´ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ë©”ì¸ í´ë˜ìŠ¤

**ì£¼ìš” ì†ì„±**:

| ì†ì„± | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `client` | ChromaDB Client | Vector DB í´ë¼ì´ì–¸íŠ¸ |
| `collection` | ChromaDB Collection | "vector_adler" ì»¬ë ‰ì…˜ |
| `openai_client` | OpenAI Client | OpenAI API í´ë¼ì´ì–¸íŠ¸ |
| `counseling_keywords` | List[str] | ìƒë‹´ í‚¤ì›Œë“œ ëª©ë¡ (200+ ê°œ) |
| `chat_history` | List[Dict] | ëŒ€í™” íˆìŠ¤í† ë¦¬ (ìµœëŒ€ 10ê°œ) |
| `persona_manager` | PersonaManager | í˜ë¥´ì†Œë‚˜ ê´€ë¦¬ì |
| `search_engine` | SearchEngine | ê²€ìƒ‰ ì—”ì§„ |
| `response_generator` | ResponseGenerator | ë‹µë³€ ìƒì„±ê¸° |

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `chat(user_input)` | ë©”ì¸ ìƒë‹´ í•¨ìˆ˜, ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ |
| `_save_qa_to_vectordb()` | Self-learning: Q&Aë¥¼ Vector DBì— ì €ì¥ |

### 2. PersonaManager

**íŒŒì¼**: `backend/councel/sourcecode/persona/persona_manager.py`

**ì—­í• **: ì•„ë“¤ëŸ¬ í˜ë¥´ì†Œë‚˜ ìƒì„± ë° ìºì‹±

**í˜ë¥´ì†Œë‚˜ ìƒì„± ë°©ì‹**:

1. **ê¸°ë³¸ í˜ë¥´ì†Œë‚˜** (ì¦‰ì‹œ ì‚¬ìš©)
   - í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ê¸°ë°˜
   - ë¹ ë¥¸ ì‹œì‘ì„ ìœ„í•œ ê¸°ë³¸ í˜ë¥´ì†Œë‚˜

2. **RAG í˜ë¥´ì†Œë‚˜** (ë°±ê·¸ë¼ìš´ë“œ ìƒì„±)
   - Vector DB ê²€ìƒ‰ + ì›¹ ê²€ìƒ‰
   - ë” ì •í™•í•˜ê³  ìƒì„¸í•œ í˜ë¥´ì†Œë‚˜
   - ìƒì„± ì™„ë£Œ í›„ ìë™ êµì²´

**ìºì‹± ë©”ì»¤ë‹ˆì¦˜**:
- ìºì‹œ íŒŒì¼: `backend/councel/cache/adler_persona_cache.json`
- ìœ íš¨ ê¸°ê°„: 24ì‹œê°„
- ë§Œë£Œ ì‹œ ìë™ ì¬ìƒì„±

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `generate_persona_with_rag()` | RAG ê¸°ë°˜ í˜ë¥´ì†Œë‚˜ ìƒì„± |
| `_generate_persona_from_rag()` | Vector DB + ì›¹ ê²€ìƒ‰ìœ¼ë¡œ í˜ë¥´ì†Œë‚˜ ìƒì„± |
| `_load_cached_persona()` | ìºì‹œëœ í˜ë¥´ì†Œë‚˜ ë¡œë“œ |
| `_save_persona_cache()` | í˜ë¥´ì†Œë‚˜ ìºì‹œ ì €ì¥ |

### 3. SearchEngine

**íŒŒì¼**: `backend/councel/sourcecode/persona/search_engine.py`

**ì—­í• **: Vector DB ê²€ìƒ‰ ë° ìœ ì‚¬ë„ ê³„ì‚°

**ì£¼ìš” ê¸°ëŠ¥**:

1. **ì„ë² ë”© ìƒì„±**
   - ëª¨ë¸: `text-embedding-3-large`
   - ì‚¬ìš©ì ì…ë ¥ì„ ë²¡í„°ë¡œ ë³€í™˜

2. **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**
   - ë²¡í„° ê²€ìƒ‰ (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
   - ê°ì • í‚¤ì›Œë“œ ê°€ì¤‘ì¹˜ ì ìš© (ìµœëŒ€ +0.2)

3. **Multi-step ê²€ìƒ‰**
   - ì´ˆê¸° ê²€ìƒ‰ â†’ í’ˆì§ˆ í‰ê°€ â†’ ì¿¼ë¦¬ í™•ì¥ â†’ ì¬ê²€ìƒ‰
   - ìµœëŒ€ 2íšŒ ë°˜ë³µ

4. **Re-ranker**
   - LLM ê¸°ë°˜ ê´€ë ¨ì„± í‰ê°€
   - ê²€ìƒ‰ ê²°ê³¼ ì¬ì •ë ¬

5. **ì¿¼ë¦¬ í™•ì¥**
   - LLMì„ í†µí•œ ê´€ë ¨ ê²€ìƒ‰ì–´ ìƒì„±
   - ê°ì • ìƒíƒœ, ì•„ë“¤ëŸ¬ ê°œë…, ìœ ì‚¬ ìƒí™© ì¶”ì¶œ

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `retrieve_chunks()` | ê¸°ë³¸ Vector DB ê²€ìƒ‰ |
| `_iterative_search_with_query_expansion()` | Multi-step ê²€ìƒ‰ |
| `rerank_chunks()` | LLM ê¸°ë°˜ ì¬ì •ë ¬ |
| `translate_to_english()` | í•œêµ­ì–´ â†’ ì˜ì–´ ë²ˆì—­ |
| `get_distance_to_similarity()` | L2 distance â†’ ìœ ì‚¬ë„ ë³€í™˜ |

### 4. ResponseGenerator

**íŒŒì¼**: `backend/councel/sourcecode/persona/response_generator.py`

**ì—­í• **: LLM ê¸°ë°˜ ë‹µë³€ ìƒì„±

**ì£¼ìš” ê¸°ëŠ¥**:

1. **ì…ë ¥ ë¶„ë¥˜**
   - "adler": ì•„ë“¤ëŸ¬ ê´€ë ¨ í‚¤ì›Œë“œ
   - "counseling": ìƒë‹´ ê´€ë ¨ í‚¤ì›Œë“œ
   - "general": ì¼ë°˜

2. **LLM ë‹¨ë… ë‹µë³€**
   - ìœ ì‚¬ë„ê°€ ë†’ì„ ë•Œ (â‰¥ 0.7)
   - RAG ì—†ì´ í˜ë¥´ì†Œë‚˜ë§Œ ì‚¬ìš©

3. **RAG ê¸°ë°˜ ë‹µë³€**
   - ìœ ì‚¬ë„ê°€ ë‚®ì„ ë•Œ (< 0.7)
   - ê²€ìƒ‰ëœ ì²­í¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©
   - 3ë‹¨ê³„ êµ¬ì¡° ê°•ì œ

**3ë‹¨ê³„ ë‹µë³€ êµ¬ì¡°**:
1. **ê°ì • ì¸ì •**: ì‚¬ìš©ìì˜ ê°ì •ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ ì¸ì •
2. **ì•„ë“¤ëŸ¬ ê´€ì  ì¬í•´ì„**: ì—´ë“±ê°ì„ ì„±ì¥ ê¸°íšŒë¡œ, ëª©í‘œ ì§€í–¥ì  ê´€ì  ì œì‹œ
3. **ê²©ë ¤ ë° ì‹¤ì²œ ë°©ì•ˆ**: ë‚´ì  í˜ ë¯¿ìŒ, êµ¬ì²´ì  ì‹¤ì²œ ë°©í–¥ ì œì‹œ

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `classify_input()` | ì‚¬ìš©ì ì…ë ¥ ë¶„ë¥˜ |
| `_generate_llm_only_response()` | LLM ë‹¨ë… ë‹µë³€ ìƒì„± |
| `generate_response_with_persona()` | RAG ê¸°ë°˜ ë‹µë³€ ìƒì„± |

### 5. TherapyService

**íŒŒì¼**: `backend/app/domain/therapy/service.py`

**ì—­í• **: ì„œë¹„ìŠ¤ ë ˆì´ì–´, ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬

**íŠ¹ì§•**:
- ì‹±ê¸€í†¤ íŒ¨í„´: í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ë§Œ ì¡´ì¬
- ì§€ì—° ì´ˆê¸°í™”: ì²« ìš”ì²­ ì‹œ RAGTherapySystem ì´ˆê¸°í™”

**ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `is_available()` | ìƒë‹´ ì‹œìŠ¤í…œ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ |
| `chat(user_input, enable_scoring)` | ìƒë‹´ ì‘ë‹µ ìƒì„± |

### 6. API ì—”ë“œí¬ì¸íŠ¸

**íŒŒì¼**: `backend/app/api/v1/endpoints/therapy.py`

**ì—”ë“œí¬ì¸íŠ¸**:

1. **POST /api/v1/therapy/chat**
   - ìƒë‹´ ìš”ì²­ ì²˜ë¦¬
   - ìš”ì²­: `{ "message": string, "enable_scoring": boolean }`
   - ì‘ë‹µ: `{ "answer": string, "mode": string, "used_chunks": string[], "continue_conversation": boolean }`

2. **GET /api/v1/therapy/status**
   - ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
   - ì‘ë‹µ: `{ "available": boolean, "system": string, "persona": string }`

### 7. í”„ë¡ íŠ¸ì—”ë“œ ëª¨ë“ˆ

#### chatService.js

**ì—­í• **: ë°±ì—”ë“œ API í˜¸ì¶œ ë‹´ë‹¹

**ì£¼ìš” í•¨ìˆ˜**:
- `callChatModule(userText)`: ë©”ì¸ ë¼ìš°íŒ… í•¨ìˆ˜
- `isTherapyRelated(text)`: ìƒë‹´ í‚¤ì›Œë“œ ê°ì§€
- `sendTherapyMessage(userText)`: Therapy API í˜¸ì¶œ

#### chatPanel.js

**ì—­í• **: UI ë° ìƒíƒœ ê´€ë¦¬

**ì£¼ìš” í•¨ìˆ˜**:
- `initChatPanel()`: íŒ¨ë„ ì´ˆê¸°í™”
- `handleSendMessage()`: ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
- `addTherapyMessage(text, mode)`: ìƒë‹´ ë©”ì‹œì§€ UI ì¶”ê°€
- `addMessage(role, text)`: ì¼ë°˜ ë©”ì‹œì§€ UI ì¶”ê°€

---

## ê¸°ìˆ  ìŠ¤íƒ ë° ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬

### ë°±ì—”ë“œ

#### í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬

| ë¼ì´ë¸ŒëŸ¬ë¦¬ | ë²„ì „ | ìš©ë„ |
|-----------|------|------|
| FastAPI | - | ì›¹ í”„ë ˆì„ì›Œí¬, API ì„œë²„ |
| ChromaDB | - | Vector ë°ì´í„°ë² ì´ìŠ¤ |
| OpenAI | - | LLM ë° ì„ë² ë”© API |
| PyMuPDF (fitz) | - | PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ |
| tiktoken | - | í† í° ìˆ˜ ê³„ì‚° |
| python-dotenv | - | í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ |

#### Vector DB

- **ë°ì´í„°ë² ì´ìŠ¤**: ChromaDB (Persistent)
- **ì»¬ë ‰ì…˜ëª…**: `vector_adler`
- **ê±°ë¦¬ í•¨ìˆ˜**: cosine (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
- **ì„ë² ë”© ëª¨ë¸**: `text-embedding-3-large`
- **ì €ì¥ ìœ„ì¹˜**: `backend/councel/vector_db/`

#### LLM

- **ëª¨ë¸**: `gpt-4o-mini`
- **ìš©ë„**:
  - ë‹µë³€ ìƒì„±
  - ë²ˆì—­ (í•œêµ­ì–´ â†’ ì˜ì–´)
  - ì¿¼ë¦¬ í™•ì¥
  - Re-ranker
  - í˜ë¥´ì†Œë‚˜ ìƒì„±
  - í’ˆì§ˆ í‰ê°€ (ìŠ¤ì½”ì–´ë§, ì£¼ì„ ì²˜ë¦¬ë¨)

### í”„ë¡ íŠ¸ì—”ë“œ

- **ì–¸ì–´**: JavaScript (ES6+)
- **API í†µì‹ **: Fetch API
- **UI**: Vanilla JavaScript (DOM ì¡°ì‘)

### ë°ì´í„° ì²˜ë¦¬

#### ì²­í‚¹ ì „ëµ

- **ë°©ì‹**: Parent-Child Chunking
- **Parent í¬ê¸°**: 1000 tokens
- **Child í¬ê¸°**: 500 tokens
- **Overlap**: 20%

#### ì„ë² ë”© ìƒì„±

- **ëª¨ë¸**: `text-embedding-3-large`
- **ë°°ì¹˜ í¬ê¸°**: 100ê°œ
- **í˜•ì‹**: 3072ì°¨ì› ë²¡í„°

#### ì €ì¥ í˜•ì‹

- **ì²­í¬ íŒŒì¼**: JSON (í…ìŠ¤íŠ¸ + ë©”íƒ€ë°ì´í„°)
- **ì„ë² ë”© íŒŒì¼**: JSON (ì²­í¬ + ì„ë² ë”© ë²¡í„°)
- **Vector DB**: ChromaDB (ì´ì§„ í˜•ì‹)

---

## ì‹œìŠ¤í…œ íë¦„ ìš”ì•½

### ì„œë²„ ì‹œì‘ ì‹œ

1. FastAPI ì•± ìƒì„±
2. ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„±
3. Vector DB ìë™ ìƒì„± (í•„ìš” ì‹œ)
   - ì²­í¬ ìƒì„±
   - ì„ë² ë”© ìƒì„±
   - Vector DB ì €ì¥
4. ìƒë‹´ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
5. ì„œë²„ ì‹œì‘ ì™„ë£Œ

### ì‚¬ìš©ì ìš”ì²­ ì‹œ

1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í‚¤ì›Œë“œ ê°ì§€
2. Therapy API í˜¸ì¶œ
3. ê²€ìƒ‰ ë° ìœ ì‚¬ë„ ê³„ì‚°
4. Threshold ë¶„ê¸°
5. ë‹µë³€ ìƒì„±
6. Self-learning (ì¡°ê±´ë¶€)
7. ì‘ë‹µ ë°˜í™˜
8. í”„ë¡ íŠ¸ì—”ë“œ ì¶œë ¥

### ì£¼ìš” íŠ¹ì§•

- **Threshold ê¸°ë°˜ ë¶„ê¸°**: ìœ ì‚¬ë„ 0.7 ê¸°ì¤€ìœ¼ë¡œ LLM/RAG ì„ íƒ
- **Multi-step ê²€ìƒ‰**: ì¿¼ë¦¬ í™•ì¥ì„ í†µí•œ ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ
- **Self-learning**: ë‚®ì€ ìœ ì‚¬ë„ì¼ ë•Œ ìë™ í•™ìŠµ
- **ë™ì  í˜ë¥´ì†Œë‚˜**: Vector DB + ì›¹ ê²€ìƒ‰ ê¸°ë°˜ ìƒì„±
- **ìºì‹±**: í˜ë¥´ì†Œë‚˜ 24ì‹œê°„ ìºì‹±

---

## íŒŒì¼ êµ¬ì¡° ìš”ì•½

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                          # FastAPI ì•±, ì„œë²„ ì‹œì‘ ì‹œ automatic_save í˜¸ì¶œ
â”‚   â””â”€â”€ domain/therapy/
â”‚       â””â”€â”€ service.py                   # TherapyService (ì„œë¹„ìŠ¤ ë ˆì´ì–´)
â”‚   â””â”€â”€ api/v1/endpoints/
â”‚       â””â”€â”€ therapy.py                   # Therapy API ì—”ë“œí¬ì¸íŠ¸
â”‚
â””â”€â”€ councel/
    â”œâ”€â”€ sourcecode/
    â”‚   â”œâ”€â”€ automatic_save.py            # ìë™ ì €ì¥ í†µí•© ê´€ë¦¬
    â”‚   â””â”€â”€ automatic_save/
    â”‚       â”œâ”€â”€ create_chunk_files.py    # ì²­í¬ ìƒì„±
    â”‚       â”œâ”€â”€ create_openai_embeddings.py  # ì„ë² ë”© ìƒì„±
    â”‚       â””â”€â”€ save_to_vectordb.py      # Vector DB ì €ì¥
    â”‚   â””â”€â”€ persona/
    â”‚       â”œâ”€â”€ rag_therapy.py           # ë©”ì¸ ìƒë‹´ ì‹œìŠ¤í…œ
    â”‚       â”œâ”€â”€ persona_manager.py       # í˜ë¥´ì†Œë‚˜ ê´€ë¦¬
    â”‚       â”œâ”€â”€ search_engine.py         # ê²€ìƒ‰ ì—”ì§„
    â”‚       â”œâ”€â”€ response_generator.py    # ë‹µë³€ ìƒì„±ê¸°
    â”‚       â””â”€â”€ therapy_logger.py        # ë¡œê¹… (ì£¼ì„ ì²˜ë¦¬ë¨)
    â”‚
    â”œâ”€â”€ vector_db/                       # ChromaDB ì €ì¥ ìœ„ì¹˜
    â”œâ”€â”€ cache/
    â”‚   â””â”€â”€ adler_persona_cache.json     # í˜ë¥´ì†Œë‚˜ ìºì‹œ
    â””â”€â”€ dataset/adler/
        â”œâ”€â”€ chunkfiles/                  # ì²­í¬ JSON íŒŒì¼ë“¤
        â””â”€â”€ embeddings/                  # ì„ë² ë”© JSON íŒŒì¼ë“¤

renderer/chat/
â”œâ”€â”€ chatService.js                       # API í˜¸ì¶œ ë‹´ë‹¹
â””â”€â”€ chatPanel.js                         # UI ë° ìƒíƒœ ê´€ë¦¬
```

---

**ë¬¸ì„œ ìƒì„±ì¼**: 2025.12.01
**ìµœì¢… ìˆ˜ì •ì¼**: 2025.12.01
