<!-- 생성일 2025.11.21 -->

# 🎭 페르소나 기반 RAG 상담 시스템 가이드

## 개요
OpenAI API를 사용한 페르소나 기반 RAG 상담 시스템입니다.
아들러 개인심리학의 상담 스타일을 적용하여 사용자에게 맞춤형 답변을 제공합니다.

## 주요 기능

### 1. 🎭 아들러 페르소나 시스템

#### 아들러 페르소나 (Alfred Adler)
**적용 시점**: 모든 입력에 적용

**특징**:
- 개인심리학 관점에서 설명
- 열등감을 성장의 기회로 재해석
- 사회적 관심과 공동체 감각 강조
- 격려와 용기를 주는 톤
- 목표 지향적 관점 제시

**답변 스타일**:
```
"~할 수 있습니다"
"~의 기회입니다"
"용기를 가지세요"
```

### 2. 🧠 지능형 입력 분류
자동으로 사용자 입력을 분석하여 처리 모드를 결정합니다.

- **아들러 모드**: "아들러", "adler" 키워드 포함
- **상담 모드**: "힘들어", "우울", "불안", "상담" 등 감정 키워드
- **일반 모드**: 기타 심리학 질문
- (모든 모드에서 아들러 페르소나 적용)

### 3. 🌐 다국어 지원
- 모든 입력을 자동으로 영어로 번역하여 Vector DB 검색
- 답변은 한국어로 생성
- 영어, 일본어, 중국어 등 다양한 언어 지원

### 4. 💾 대화 히스토리 관리 (단기 기억)
- 최근 10개의 대화 저장
- 이전 대화 맥락을 고려한 답변 생성
- 자연스러운 대화 흐름 유지

### 5. 📚 RAG 기반 답변
- Vector DB에서 관련 자료 검색
- 검색된 자료를 페르소나 스타일로 재구성
- 출처 명시로 신뢰성 확보

## 기술 스택

### OpenAI API
- **임베딩**: text-embedding-3-large (고정밀도)
- **답변 생성**: gpt-4o-mini
- **번역**: gpt-4o-mini

### Vector Database
- **ChromaDB**: 영구 저장소
- **컬렉션**: paragraph_vec, semantic_vec

### 페르소나 엔지니어링
- 아들러 개인심리학 기반 프롬프트 설계
- 맥락 기반 대화 생성

## 사용 방법

### 1. 환경 설정
프로젝트 루트에 `.env` 파일 확인:
```bash
OPENAI_API_KEY=your_openai_api_key_here
```

### 2. 실행
```bash
cd backend/councel/sourcecode/persona
python rag_therapy.py
```

### 3. DB 선택
```
1. 문단 기반 (paragraph_vec)
2. 의미 기반 (semantic_vec)
```

### 4. 대화 시작

## 대화 예시

### 예시 1: 아들러 모드
```
[사용자] 아들러의 열등감 이론에 대해 설명해줘

📋 입력 유형: 아들러 모드
🌐 영어로 번역 중...
✓ 번역 완료: Explain Adler's theory of inferiority...
🔍 아들러 자료 검색 중...
✓ 3개의 관련 자료를 찾았습니다.
🎭 아들러 페르소나 적용 중...

[🎭 아들러 상담사]
아들러의 열등감 이론은 인간 성장의 핵심 동력입니다. 
모든 사람은 열등감을 느끼며, 이는 부정적인 것이 아니라 
우월성을 추구하는 원동력이 됩니다. 

이 열등감을 극복하려는 노력이 바로 개인의 성장을 
이끄는 힘입니다. 당신도 이러한 과정을 통해 
더 나은 자신으로 발전할 수 있습니다.
```

### 예시 2: 상담 모드
```
[사용자] 요즘 너무 힘들어, 상담 좀 해줘

📋 입력 유형: 상담 모드
🌐 영어로 번역 중...
✓ 번역 완료: I'm having a really hard time lately...
🔍 관련 자료 검색 중...
✓ 2개의 관련 자료를 찾았습니다.
🎭 아들러 페르소나 적용 중...

[🎭 아들러 상담사]
힘드신 상황을 겪고 계시는군요. 아들러의 관점에서 보면,
이런 어려움은 성장의 기회가 될 수 있습니다.

열등감을 느끼는 것은 자연스러운 일이며, 이를 극복하려는 
노력이 바로 개인의 성장을 이끄는 힘입니다. 

사회적 관심을 가지고 주변 사람들과 연결되려는 노력이
이런 어려움을 극복하는 데 도움이 될 수 있습니다.
```

### 예시 3: 다국어 지원
```
[사용자] Tell me about Adler's concept of social interest

📋 입력 유형: 아들러 모드
🌐 영어로 번역 중...
✓ 번역 완료: Tell me about Adler's concept of social interest
🔍 아들러 자료 검색 중...
✓ 3개의 관련 자료를 찾았습니다.
🎭 아들러 페르소나 적용 중...

[🎭 아들러 상담사]
아들러의 사회적 관심(Social Interest)은 개인심리학의 
핵심 개념입니다. 이는 공동체 감각으로도 불리며...
(한국어로 답변)
```

## 처리 플로우

```
사용자 입력
    ↓
입력 분류 (아들러/상담/일반)
    ↓
영어 번역
    ↓
Vector DB 검색
    ↓
페르소나 선택
    ↓
RAG + 페르소나 답변 생성
    ↓
대화 히스토리 저장
    ↓
한국어 출력
```

## 비용 최적화

### 임베딩
- text-embedding-3-large: 고정밀도, 적절한 비용
- 검색당 1회 임베딩 생성

### 답변 생성
- gpt-4o-mini: 비용 효율적
- max_tokens 제한으로 비용 관리
- 모든 모드: 1000 tokens

### 대화 히스토리
- 최근 2개 대화만 컨텍스트에 포함
- 최대 10개 대화 저장 (메모리 관리)

## 향후 개선 사항

- [ ] 장기 기억 시스템 (데이터베이스 연동)
- [ ] 세션 관리 (사용자별 대화 저장)
- [ ] 감정 분석 강화 (감정 점수 추적)
- [ ] 웹 인터페이스 개발
- [ ] 음성 입출력 지원
- [ ] 다중 언어 출력 지원

## 문제 해결

### OpenAI API 키 오류
```bash
# .env 파일 확인
OPENAI_API_KEY=sk-...
```

### Vector DB 경로 오류
```bash
# Vector DB 경로 확인
backend/councel/vector_db/
```

### 임베딩 모델 오류
- text-embedding-3-large 모델 사용 확인
- OpenAI API 크레딧 확인

## 참고 자료

- `rag_therapy_algorithm.md`: 시스템 알고리즘 및 구조 설명
- `create_rag_therapy.md`: 개발 요구사항 문서

